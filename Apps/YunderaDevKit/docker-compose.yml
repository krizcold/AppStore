name: yunderadevkit

services:
  yunderadevkit:
    image: ghcr.io/yundera/nginx-hash-lock:latest
    container_name: yunderadevkit
    restart: unless-stopped
    expose:
      - "80"
    labels:
      - "caddy=yunderadevkit-${APP_DOMAIN}"
      - "caddy.reverse_proxy={{upstreams 80}}"
    user: "root"
    environment:
      AUTH_HASH: $AUTH_HASH
      BACKEND_HOST: "yunderadevkitapp"
      BACKEND_PORT: "80"
      LISTEN_PORT: "80"
      ALLOWED_EXTENSIONS: "js,css,png,ico,svg,jpg,jpeg,gif,woff,woff2,ttf,eot"
      ALLOWED_PATHS: "api/app,build-info"
    depends_on:
      - yunderadevkitapp
    networks:
      - pcs
    privileged: true
    cap_add:
      - SYS_ADMIN
      - NET_ADMIN

  yunderadevkitapp:
    image: ghcr.io/krizcold/yundera-dev-kit:latest
    container_name: yunderadevkitapp
    restart: unless-stopped
    user: "root"
    entrypoint: ["/bin/sh"]
    command:
      - -c
      - |
        npm run setup
    environment:
      # Application settings
      WEBUI_PORT: "80"

      # CasaOS integration
      DEPLOYMENT_MODE: "appstore"
      CASAOS_API_HOST: "localhost"
      CASAOS_API_PORT: "8080"

      # Pass through the host's CasaOS environment variables.
      # These will be populated by the AppStore during installation.

      # Hardcoded/built-in variables
      PUID: $PUID
      PGID: $PGID
      TZ: $TZ
      DefaultUserName: $DefaultUserName
      DefaultPassword: $DefaultPassword

      # CasaOS container OS environment variables
      default_pwd: $default_pwd
      public_ip: $public_ip
      domain: $domain
      USER: $USER

      # PCS environment variables (MUST be included)
      PCS_DEFAULT_PASSWORD: $PCS_DEFAULT_PASSWORD
      PCS_DOMAIN: $PCS_DOMAIN
      PCS_DATA_ROOT: $PCS_DATA_ROOT
      PCS_PUBLIC_IP: $PCS_PUBLIC_IP
      PCS_PUBLIC_IPV6: $PCS_PUBLIC_IPV6
      PCS_EMAIL: $PCS_EMAIL

      # REF variables
      REF_DOMAIN: $REF_DOMAIN
      REF_NET: $REF_NET
      REF_SCHEME: $REF_SCHEME
      REF_PORT: $REF_PORT
      REF_SEPARATOR: $REF_SEPARATOR
      REF_DEFAULT_PORT: $REF_DEFAULT_PORT

      # Data root
      DATA_ROOT: $DATA_ROOT

      # SMTP variables
      SMTP_HOST: $SMTP_HOST
      SMTP_PORT: $SMTP_PORT

    volumes:        
      # cloned repos
      - type: bind
        source: /DATA/AppData/yunderadevkit/repos/
        target: /app/repos/

      # persistent UI data storage
      - type: bind
        source: /DATA/AppData/yunderadevkit/uidata/
        target: /app/uidata/

      # Writable mount for app metadata
      - type: bind
        source: /DATA/AppData/
        target: /DATA/AppData/

      # Bind mount for the main app directory
      - type: bind
        source: /DATA/AppData/casaos/apps/yunderadevkit/
        target: /DATA/AppData/casaos/apps/yunderadevkit/
        read_only: true

      - type: bind
        source: /var/run/docker.sock
        target: /var/run/docker.sock

    # Connect to the same network as the CasaOS service
    networks:
      - pcs
    
    # Add privileges to access CasaOS data (similar to CasaOS container)
    privileged: true
    
    # Add capabilities
    cap_add:
      - SYS_ADMIN
      - NET_ADMIN
    
    # Resource limits
    cpu_shares: 50
    deploy:
      resources:
        limits:
          memory: 512M

    x-casaos:
      volumes:
        - container: /app/repos/
          description:
            en_us: "Git repos are cloned here."
        - container: /app/uidata/
          description:
            en_us: "Persistent UI data storage."

# Define the network as external, since it's created by the main NSL stack
networks:
  pcs:
    external: true

x-casaos:
  architectures:
    - amd64
    - arm64
  main: yunderadevkit
  author: krizcold
  developer: krizcold
  icon: https://cdn.statically.io/gh/krizcold/Yundera-Dev-Kit/main/YunderaCompiler.png
  tagline:
    en_us: "Automatically build and deploy GitHub repos on Yundera"
  category: Utilities
  description:
    en_us: "Clone, build, and run Docker-based projects directly from GitHub URLs."
  title:
    en_us: "Yundera Dev Kit"
  store_app_id: yunderadevkit
  is_uncontrolled: false
  index: /?hash=$AUTH_HASH
  webui_port: 80
