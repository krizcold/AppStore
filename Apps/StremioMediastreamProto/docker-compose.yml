name: mediafusionproto

services:
  # Landing page backend - serves static HTML (no external hostname)
  landingbackend:
    image: nginx:alpine
    container_name: mediafusionprotolandingbackend
    restart: unless-stopped
    user: "0:0"
    expose:
      - 80
    volumes:
      - /DATA/AppData/mediafusionproto/config:/usr/share/nginx/html:ro
    tmpfs:
      - /var/cache/nginx:size=10M
      - /run:size=10M
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:80/"]
      interval: 5s
      timeout: 3s
      retries: 3
      start_period: 5s
    depends_on:
      mediafusion:
        condition: service_healthy
    networks:
      - pcs
    cpu_shares: 10
    deploy:
      resources:
        limits:
          memory: 64M

  # Landing page proxy - hash-protected access
  landing:
    image: ghcr.io/yundera/nginx-hash-lock:latest
    container_name: mediafusionprotolanding
    hostname: mediafusionproto
    restart: unless-stopped
    user: "root"
    expose:
      - 80
    environment:
      BACKEND_HOST: "landingbackend"
      BACKEND_PORT: "80"
      LISTEN_PORT: "80"
      AUTH_HASH: "$AUTH_HASH"
    tmpfs:
      - /var/cache/nginx:size=50M
    healthcheck:
      test: ["CMD", "pidof", "nginx"]
      interval: 5s
      timeout: 3s
      retries: 3
      start_period: 5s
    depends_on:
      landingbackend:
        condition: service_healthy
    networks:
      - pcs
    cpu_shares: 10
    deploy:
      resources:
        limits:
          memory: 64M

  # Proxy for MediaFusion API (mesh-router needs port 80)
  mediafusionproxy:
    image: nginx:alpine
    container_name: mediafusionprotoapiproxy
    hostname: mediafusionprotoapi
    restart: unless-stopped
    user: "0:0"
    expose:
      - 80
    volumes:
      - /DATA/AppData/mediafusionproto/nginx-api.conf:/etc/nginx/conf.d/default.conf:ro
    tmpfs:
      - /var/cache/nginx:size=10M
      - /run:size=10M
    depends_on:
      - mediafusion
    networks:
      - pcs
    cpu_shares: 10
    deploy:
      resources:
        limits:
          memory: 64M

  # Main MediaFusion API - Stremio addon
  mediafusion:
    image: mhdzumair/mediafusion:latest
    container_name: mediafusionproto
    restart: unless-stopped
    expose:
      - 8000
    environment:
      HOST_URL: "https://mediafusionprotoapi-${REF_DOMAIN}"
      SECRET_KEY: "${PCS_DEFAULT_PASSWORD}!mfkey!!"
      API_PASSWORD: "${PCS_DEFAULT_PASSWORD}"
      ADDON_NAME: "MediaFusion (Proto)"
      LOGGING_LEVEL: "DEBUG"
      IS_PUBLIC_INSTANCE: "false"
      MONGO_URI: "mongodb://mongodb:27017/mediafusion"
      POSTGRES_URI: "postgresql+asyncpg://mediafusion:mediafusion@postgres:5432/mediafusion"
      REDIS_URL: "redis://redis:6379"
      FLARESOLVERR_URL: "http://byparr:8191/v1"
      PLAYWRIGHT_CDP_URL: "ws://browserless:3000?blockAds=true&stealth=true"
      # Prowlarr enabled - user must configure their own indexers
      is_scrap_from_prowlarr: "true"
      prowlarr_url: "http://prowlarr:9696"
      prowlarr_api_key: "a1b2c3d4e5f6a1b2c3d4e5f6a1b2c3d4"
      # All built-in scrapers disabled by default (legal reasons)
      # User can enable these manually if they choose
      is_scrap_from_bt4g: "false"
      is_scrap_from_yts: "false"
      is_scrap_from_torrentio: "false"
      is_scrap_from_mediafusion: "false"
      is_scrap_from_zilean: "false"
      is_scrap_from_jackett: "false"
    depends_on:
      mongodb:
        condition: service_healthy
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 2m
    networks:
      - pcs
    cpu_shares: 50
    deploy:
      resources:
        limits:
          memory: 512M

  # qBittorrent with WebDAV
  qbittorrent:
    image: mhdzumair/qbittorrent-webdav:latest
    container_name: mediafusionprotoqbittorrent
    restart: unless-stopped
    user: "0:0"
    ports:
      - "8083:80"
      - "6881:6881/tcp"
      - "6881:6881/udp"
    environment:
      PUID: "1000"
      PGID: "1000"
    volumes:
      - /DATA/AppData/mediafusionproto/qbittorrent/downloads:/downloads
      - /DATA/AppData/mediafusionproto/qbittorrent/config:/config
    networks:
      - pcs

  # qBittorrent API proxy - fixes duplicate torrent handling
  # MediaFusion bug: doesn't check if torrent exists before adding
  # qBittorrent returns "Fails." for duplicates, MediaFusion treats as error
  # This proxy uses nginx mirror to fire-and-forget to qBittorrent while returning "Ok."
  qbittorrent-api:
    image: nginx:alpine
    container_name: mediafusionprotoqbittorrentapi
    restart: unless-stopped
    user: "0:0"
    expose:
      - 80
    volumes:
      - /DATA/AppData/mediafusionproto/nginx-qbapi.conf:/etc/nginx/conf.d/default.conf:ro
    tmpfs:
      - /var/cache/nginx:size=10M
      - /run:size=10M
    depends_on:
      - qbittorrent
    networks:
      - pcs
    cpu_shares: 10
    deploy:
      resources:
        limits:
          memory: 64M

  # Proxy for qBittorrent WebUI
  qbittorrentproxy:
    image: ghcr.io/yundera/nginx-hash-lock:latest
    container_name: mediafusionprotoqbittorrentproxy
    hostname: mediafusionprotoqbittorrent
    restart: unless-stopped
    user: "root"
    expose:
      - 80
    environment:
      BACKEND_HOST: "qbittorrent"
      BACKEND_PORT: "80"
      BACKEND_PATH: "/qbittorrent/"
      LISTEN_PORT: "80"
      USERNAME: "admin"
      PASSWORD: "${PCS_DEFAULT_PASSWORD}"
    tmpfs:
      - /var/cache/nginx:size=50M
    depends_on:
      - qbittorrent
    networks:
      - pcs
    cpu_shares: 10
    deploy:
      resources:
        limits:
          memory: 64M

  # WebDAV proxy for external Stremio access (no auth required)
  webdavproxy:
    image: nginx:alpine
    container_name: mediafusionprotowebdavproxy
    hostname: mediafusionprotowebdav
    restart: unless-stopped
    user: "0:0"
    expose:
      - 80
    volumes:
      - /DATA/AppData/mediafusionproto/nginx-webdav.conf:/etc/nginx/conf.d/default.conf:ro
    tmpfs:
      - /var/cache/nginx:size=10M
      - /run:size=10M
    depends_on:
      - qbittorrent
    networks:
      - pcs
    cpu_shares: 10
    deploy:
      resources:
        limits:
          memory: 64M

  # Proxy for Prowlarr UI
  prowlarrproxy:
    image: ghcr.io/yundera/nginx-hash-lock:latest
    container_name: mediafusionprotoprowlarrproxy
    hostname: mediafusionprotoprowlarr
    restart: unless-stopped
    user: "root"
    expose:
      - 80
    environment:
      BACKEND_HOST: "prowlarr"
      BACKEND_PORT: "9696"
      LISTEN_PORT: "80"
      USERNAME: "admin"
      PASSWORD: "${PCS_DEFAULT_PASSWORD}"
    tmpfs:
      - /var/cache/nginx:size=50M
    depends_on:
      - prowlarr
    networks:
      - pcs
    cpu_shares: 10
    deploy:
      resources:
        limits:
          memory: 64M

  # Background task worker
  dramatiqworker:
    image: mhdzumair/mediafusion:latest
    container_name: mediafusionprotoworker
    restart: unless-stopped
    command: ["dramatiq", "api.task", "-p", "1", "-t", "4"]
    environment:
      HOST_URL: "https://mediafusionprotoapi-${REF_DOMAIN}"
      API_PASSWORD: "${PCS_DEFAULT_PASSWORD}"
      MONGO_URI: "mongodb://mongodb:27017/mediafusion"
      POSTGRES_URI: "postgresql+asyncpg://mediafusion:mediafusion@postgres:5432/mediafusion"
      REDIS_URL: "redis://redis:6379"
      SECRET_KEY: "${PCS_DEFAULT_PASSWORD}!mfkey!!"
    depends_on:
      mongodb:
        condition: service_healthy
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - pcs
    cpu_shares: 30
    deploy:
      resources:
        limits:
          memory: 256M

  # PostgreSQL
  postgres:
    image: postgres:16-alpine
    container_name: mediafusionprotopostgres
    restart: unless-stopped
    user: "0:0"
    environment:
      POSTGRES_USER: mediafusion
      POSTGRES_PASSWORD: mediafusion
      POSTGRES_DB: mediafusion
    command:
      - "postgres"
      - "-c"
      - "shared_buffers=128MB"
      - "-c"
      - "effective_cache_size=384MB"
      - "-c"
      - "maintenance_work_mem=64MB"
      - "-c"
      - "work_mem=8MB"
    volumes:
      - /DATA/AppData/mediafusionproto/postgres:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U mediafusion -d mediafusion"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - pcs
    cpu_shares: 30
    deploy:
      resources:
        limits:
          memory: 256M

  # MongoDB
  mongodb:
    image: mongo:7
    container_name: mediafusionprotomongodb
    restart: unless-stopped
    user: "0:0"
    volumes:
      - /DATA/AppData/mediafusionproto/mongodb:/data/db
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
      interval: 10s
      timeout: 10s
      retries: 5
      start_period: 40s
    networks:
      - pcs
    cpu_shares: 30
    deploy:
      resources:
        limits:
          memory: 256M

  # Redis
  redis:
    image: redis:7-alpine
    container_name: mediafusionprotoredis
    restart: unless-stopped
    user: "0:0"
    command: redis-server --appendonly yes --save 60 1
    volumes:
      - /DATA/AppData/mediafusionproto/redis:/data
    healthcheck:
      test: ["CMD-SHELL", "redis-cli --raw INFO | grep -q '^loading:0'"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - pcs
    cpu_shares: 20
    deploy:
      resources:
        limits:
          memory: 128M

  # Prowlarr - Indexer aggregator
  prowlarr:
    image: lscr.io/linuxserver/prowlarr:latest
    container_name: mediafusionprotoprowlarr
    restart: unless-stopped
    environment:
      PUID: "0"
      PGID: "0"
      TZ: "UTC"
    expose:
      - 9696
    volumes:
      - /DATA/AppData/mediafusionproto/prowlarr:/config
    networks:
      - pcs
    cpu_shares: 20
    deploy:
      resources:
        limits:
          memory: 256M

  # One-time setup: Configure FlareSolverr proxy in Prowlarr
  prowlarr-setup:
    image: curlimages/curl:latest
    container_name: mediafusionprotoprowlarrsetup
    depends_on:
      - prowlarr
    restart: "no"
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        echo "Waiting for Prowlarr to be ready..."
        until curl -s -f "http://prowlarr:9696/api/v1/health" -H "X-Api-Key: a1b2c3d4e5f6a1b2c3d4e5f6a1b2c3d4" > /dev/null 2>&1; do
          sleep 5
        done
        echo "Prowlarr is ready. Checking if FlareSolverr proxy exists..."
        EXISTING=$(curl -s "http://prowlarr:9696/api/v1/indexerproxy" -H "X-Api-Key: a1b2c3d4e5f6a1b2c3d4e5f6a1b2c3d4")
        if echo "$$EXISTING" | grep -q "FlareSolverr"; then
          echo "FlareSolverr proxy already configured."
        else
          echo "Creating 'cf' tag..."
          TAG_RESPONSE=$$(curl -s -X POST "http://prowlarr:9696/api/v1/tag" \
            -H "Content-Type: application/json" \
            -H "X-Api-Key: a1b2c3d4e5f6a1b2c3d4e5f6a1b2c3d4" \
            -d '{"label":"cf"}')
          TAG_ID=$$(echo "$$TAG_RESPONSE" | grep -o '"id":[0-9]*' | grep -o '[0-9]*')
          echo "Created tag with ID: $$TAG_ID"
          echo "Adding FlareSolverr proxy with tag id $$TAG_ID..."
          curl -s -X POST "http://prowlarr:9696/api/v1/indexerproxy" \
            -H "Content-Type: application/json" \
            -H "X-Api-Key: a1b2c3d4e5f6a1b2c3d4e5f6a1b2c3d4" \
            -d "{\"name\":\"Byparr\",\"fields\":[{\"name\":\"host\",\"value\":\"http://byparr:8191\"},{\"name\":\"requestTimeout\",\"value\":180}],\"implementationName\":\"FlareSolverr\",\"implementation\":\"FlareSolverr\",\"configContract\":\"FlareSolverrSettings\",\"tags\":[$$TAG_ID]}"
          echo ""
          echo "FlareSolverr proxy added with cf tag."
        fi
        echo "Setup complete."
    networks:
      - pcs

  # Byparr - Cloudflare bypass (replaces FlareSolverr which is now broken)
  # Increased resources to reduce cold start time (~200s → faster)
  byparr:
    image: ghcr.io/thephaseless/byparr:latest
    container_name: mediafusionprotobyparr
    restart: unless-stopped
    user: "0:0"
    expose:
      - 8191
    environment:
      - UV_CACHE_DIR=/tmp/uv-cache
    tmpfs:
      - /tmp:size=512M
    # Override slow built-in healthcheck (their /health loads a page with Playwright, takes 30s+)
    # Just check if the port is listening
    healthcheck:
      test: ["CMD-SHELL", "curl -f -s http://localhost:8191/ || exit 0"]
      interval: 60s
      timeout: 5s
      retries: 3
      start_period: 60s
    networks:
      - pcs
    cpu_shares: 50
    deploy:
      resources:
        limits:
          memory: 1024M

  # Keep-warm sidecar: pings Byparr every 2 minutes to prevent cold starts
  byparr-keepwarm:
    image: curlimages/curl:latest
    container_name: mediafusionprotobyparrkeepalive
    restart: unless-stopped
    depends_on:
      - byparr
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        echo "Byparr keep-warm service started"
        sleep 180
        while true; do
          echo "Pinging Byparr to keep warm..."
          curl -s -X POST "http://byparr:8191/v1" \
            -H "Content-Type: application/json" \
            -d '{"cmd":"request.get","url":"https://example.com","maxTimeout":60000}' > /dev/null 2>&1 || true
          sleep 120
        done
    networks:
      - pcs
    cpu_shares: 5
    deploy:
      resources:
        limits:
          memory: 16M

  # Browserless - Headless Chrome
  browserless:
    image: ghcr.io/browserless/chromium
    container_name: mediafusionprotobrowserless
    restart: unless-stopped
    environment:
      TIMEOUT: "-1"
    expose:
      - 3000
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/json/version"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - pcs
    cpu_shares: 30
    deploy:
      resources:
        limits:
          memory: 512M

networks:
  pcs:
    external: true

x-casaos:
  architectures:
    - amd64
    - arm64
  main: landing
  author: Yundera
  developer: mhdzumair
  icon: https://cdn.jsdelivr.net/gh/krizcold/AppStore@main/Apps/StremioMediastream/icon.png
  tagline:
    en_us: Stremio addon with real torrent downloads via qBittorrent
  category: Media
  description:
    en_us: |
      PROTOTYPE - MediaFusion with step-by-step setup guide.

      ⚠️ FOR INTERNAL TESTING ONLY - NOT FOR PRODUCTION ⚠️

      Features:
      - qBittorrent backend with WebDAV streaming
      - IPv6 port 6881 exposed for peer connections
      - 10x more peers than Stremio's built-in engine
      - User-configured sources via Prowlarr

      SETUP REQUIRED - Follow the step-by-step instructions on the landing page.
  title:
    en_us: MediaFusion (Prototype)
  store_app_id: mediafusionproto
  is_uncontrolled: false
  index: /?hash=$AUTH_HASH
  webui_port: 80
  pre-install-cmd: |
    curl -fsSL https://raw.githubusercontent.com/krizcold/AppStore/main/Apps/StremioMediastreamProto/scripts/pre-install.sh | bash
  tips:
    before_install:
      en_us: |
        ⚠️ PROTOTYPE - FOR TESTING ONLY ⚠️

        After installation:
        1. Open the app landing page
        2. Follow the step-by-step instructions
        3. Configure MediaFusion with qBittorrent
        4. Add your own indexers via Prowlarr
        5. Install the addon in Stremio

        Port 6881 exposed on IPv6 for 10x better peer connectivity.
