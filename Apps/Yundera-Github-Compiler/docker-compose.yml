name: yunderagithubcompiler

services:
  yunderagithubcompiler:
    image: krizcold/yundera-github-compiler:latest
    container_name: yunderagithubcompiler
    restart: unless-stopped
    expose:
      - "3000"
    user: "root"
    entrypoint: ["/bin/sh"]
    command:
      - -c
      - |
        npm run setup
    environment:
      # Application settings
      WEBUI_PORT: "3000"
      
      # CasaOS integration
      DEPLOYMENT_MODE: "appstore"
      CASAOS_API_HOST: "localhost"
      CASAOS_API_PORT: "8080"
      DATA_ROOT: $DATA_ROOT

    volumes:        
      # cloned repos
      - type: bind
        source: /DATA/AppData/yunderagithubcompiler/repos
        target: /app/repos

      # persistent UI data storage
      - type: bind
        source: /DATA/AppData/yunderagithubcompiler/uidata
        target: /app/uidata

      # Mount DATA directory as read-only
      - type: bind
        source: /DATA
        target: /DATA
        read_only: true

      - type: bind
        source: /var/run/docker.sock
        target: /var/run/docker.sock

    # Connect to the same network as the CasaOS service
    networks:
      - pcs
    
    # Add privileges to access CasaOS data (similar to CasaOS container)
    privileged: true
    
    # Add capabilities
    cap_add:
      - SYS_ADMIN
      - NET_ADMIN

    x-casaos:
      volumes:
        - container: /app/repos
          description:
            en_us: "Git repos are cloned here."
        - container: /app/uidata
          description:
            en_us: "Persistent UI data storage."

# Define the network as external, since it's created by the main NSL stack
networks:
  pcs:
    external: true

x-casaos:
  architectures:
    - amd64
    - arm64
  main: yunderagithubcompiler
  author: krizcold
  developer: krizcold
  icon: https://github.com/krizcold/Yundera-Github-Compiler/blob/main/YunderaCompiler.png?raw=true
  tagline:
    en_us: "Automatically build and deploy GitHub repos on Yundera"
  category: Utilities
  description:
    en_us: "Clone, build, and run Docker-based projects directly from GitHub URLs."
  title:
    en_us: "Yundera GitHub Compiler"
  store_app_id: yunderagithubcompiler
  is_uncontrolled: false
  index: /
  webui_port: 3000
  pre-install-cmd: |
    #!/bin/bash
    set -e
    
    echo "üöÄ Synchronous pre-install fixer started."

    # --- Step 1: Generate secrets and detect GID ---
    AUTH_HASH=$(openssl rand -hex 32)
    if [ -z "$AUTH_HASH" ]; then
      echo "‚ùå Failed to generate AUTH_HASH, aborting"
      exit 1
    fi
    echo "üîê Generated AUTH_HASH: ${AUTH_HASH:0:16}..."

    echo "üîç Detecting Docker group ID..."
    if [ -S /var/run/docker.sock ]; then
      DOCKER_GID=$(stat -c '%g' /var/run/docker.sock)
      echo "‚úÖ Docker group ID detected: $DOCKER_GID"
    else
      echo "‚ùå Docker socket not found on host, using fallback GID"
      DOCKER_GID=999
    fi

    # --- Step 2: Define paths and wait for the installer to create the compose file ---
    COMPOSE_FILE="/DATA/AppData/casaos/apps/yunderagithubcompiler/docker-compose.yml"
    echo "‚è≥ Waiting for the installer to create the compose file at $COMPOSE_FILE..."
    
    counter=0
    max_wait=120 # 2 minutes

    while [ $counter -lt $max_wait ]; do
      if [ -f "$COMPOSE_FILE" ]; then
        echo "‚úÖ Compose file found after $counter seconds."
        break
      fi
      sleep 2
      counter=$((counter + 2))
    done

    if [ ! -f "$COMPOSE_FILE" ]; then
      echo "‚ùå Compose file was not created after ${max_wait}s. Aborting."
      exit 1
    fi

    # --- Step 3: Modify the compose file IN-PLACE before the installer uses it ---
    echo "üîß Modifying the compose file to add docker.sock and secrets..."

    # Backup original just in case
    cp "$COMPOSE_FILE" "$COMPOSE_FILE.backup"

    # Add the docker.sock mount. This assumes a 'read_only: true' line exists for another volume.
    # This is more robust than assuming a specific line number.
    sed -i '/^[[:space:]]*read_only:[[:space:]]*true/a\
          - type: bind\n          source: /var/run/docker.sock\n          target: /var/run/docker.sock' "$COMPOSE_FILE"

    # Add Docker group ID and AUTH_HASH as environment variables
    sed -i "/WEBUI_PORT:/a\      DOCKER_GID: \"$DOCKER_GID\"\n      AUTH_HASH: \"$AUTH_HASH\"" "$COMPOSE_FILE"
    
    # IMPORTANT: Find the 'index:' line and replace it to include the *literal hash value*.
    # This avoids the Docker Compose variable substitution problem entirely.
    sed -i "s|index: /|index: /?hash=$AUTH_HASH|" "$COMPOSE_FILE"

    # --- Step 4: Verify and Exit ---
    if grep -q "source: /var/run/docker.sock" "$COMPOSE_FILE" && grep -q "AUTH_HASH: \"$AUTH_HASH\"" "$COMPOSE_FILE"; then
      echo "‚úÖ Successfully modified compose file. The installer can now proceed."
    else
      echo "‚ùå Failed to modify the compose file. Please check the sed commands."
      exit 1
    fi

    echo "üèÅ Synchronous pre-install fixer finished. Handing control back to the installer."
    