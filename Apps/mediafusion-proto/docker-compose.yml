name: mediafusion

services:
  # Landing page - serves pre-configured addon URL (generated by pre-install-cmd)
  landing:
    image: nginx:alpine
    container_name: mediafusion-landing
    hostname: mediafusion-setup
    restart: unless-stopped
    expose:
      - 80
    volumes:
      - /DATA/AppData/mediafusion/config:/usr/share/nginx/html:ro
    depends_on:
      - mediafusion
    networks:
      - pcs
    cpu_shares: 10
    deploy:
      resources:
        limits:
          memory: 64M

  # Main MediaFusion API - Stremio addon
  mediafusion:
    image: mhdzumair/mediafusion:latest
    container_name: mediafusion
    hostname: mediafusion
    restart: unless-stopped
    expose:
      - 8000
    environment:
      HOST_URL: "https://mediafusion-${REF_DOMAIN}"
      SECRET_KEY: "${PCS_DEFAULT_PASSWORD}${PCS_DEFAULT_PASSWORD}"
      API_PASSWORD: "${PCS_DEFAULT_PASSWORD}"
      ADDON_NAME: "MediaFusion"
      LOGGING_LEVEL: "INFO"
      IS_PUBLIC_INSTANCE: "false"
      MONGO_URI: "mongodb://mongodb:27017/mediafusion"
      POSTGRES_URI: "postgresql+asyncpg://mediafusion:mediafusion@postgres:5432/mediafusion"
      REDIS_URL: "redis://redis:6379"
      FLARESOLVERR_URL: "http://flaresolverr:8191/v1"
      PLAYWRIGHT_CDP_URL: "ws://browserless:3000?blockAds=true&stealth=true"
      # PROTOTYPE - automatic scrapers ENABLED for testing
      IS_SCRAP_FROM_PROWLARR: "false"
      PROWLARR_URL: "http://mediafusion-prowlarr:9696"
      IS_SCRAP_FROM_BT4G: "true"
      IS_SCRAP_FROM_YTS: "true"
    depends_on:
      mongodb:
        condition: service_healthy
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 1m
      timeout: 10s
      retries: 5
      start_period: 5m
    networks:
      - pcs
    cpu_shares: 50
    deploy:
      resources:
        limits:
          memory: 512M

  # qBittorrent with WebDAV - HOST NETWORK for IPv6 peer connections
  qbittorrent:
    image: mhdzumair/qbittorrent-webdav:latest
    container_name: qbittorrent
    restart: unless-stopped
    network_mode: host
    user: "0:0"
    environment:
      QBT_EULA: "accept"
      QBT_WEBUI_PORT: "8081"
      PUID: "1000"
      PGID: "1000"
    volumes:
      - /DATA/AppData/mediafusion/qbittorrent/downloads:/downloads
      - /DATA/AppData/mediafusion/qbittorrent/config:/config

  # Proxy for qBittorrent WebUI
  qbittorrent-proxy:
    image: ghcr.io/yundera/nginx-hash-lock:latest
    container_name: qbittorrent-proxy
    hostname: qbittorrent
    restart: unless-stopped
    user: "root"
    expose:
      - 80
    environment:
      BACKEND_HOST: "172.18.0.1"
      BACKEND_PORT: "8081"
      LISTEN_PORT: "80"
      USERNAME: "admin"
      PASSWORD: "${PCS_DEFAULT_PASSWORD}"
    tmpfs:
      - /var/cache/nginx:size=50M
    depends_on:
      - qbittorrent
    networks:
      - pcs
    cpu_shares: 10
    deploy:
      resources:
        limits:
          memory: 64M

  # Proxy for Prowlarr UI
  prowlarr-proxy:
    image: ghcr.io/yundera/nginx-hash-lock:latest
    container_name: prowlarr-proxy
    hostname: prowlarr
    restart: unless-stopped
    user: "root"
    expose:
      - 80
    environment:
      BACKEND_HOST: "mediafusion-prowlarr"
      BACKEND_PORT: "9696"
      LISTEN_PORT: "80"
      USERNAME: "admin"
      PASSWORD: "${PCS_DEFAULT_PASSWORD}"
    tmpfs:
      - /var/cache/nginx:size=50M
    depends_on:
      - prowlarr
    networks:
      - pcs
    cpu_shares: 10
    deploy:
      resources:
        limits:
          memory: 64M

  # Background task worker
  dramatiq-worker:
    image: mhdzumair/mediafusion:latest
    container_name: mediafusion-worker
    restart: unless-stopped
    command: ["dramatiq", "api.task", "-p", "1", "-t", "4"]
    environment:
      MONGO_URI: "mongodb://mongodb:27017/mediafusion"
      POSTGRES_URI: "postgresql+asyncpg://mediafusion:mediafusion@postgres:5432/mediafusion"
      REDIS_URL: "redis://redis:6379"
      SECRET_KEY: "${PCS_DEFAULT_PASSWORD}${PCS_DEFAULT_PASSWORD}"
    depends_on:
      mongodb:
        condition: service_healthy
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - pcs
    cpu_shares: 30
    deploy:
      resources:
        limits:
          memory: 256M

  # PostgreSQL
  postgres:
    image: postgres:16-alpine
    container_name: mediafusion-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: mediafusion
      POSTGRES_PASSWORD: mediafusion
      POSTGRES_DB: mediafusion
    command:
      - "postgres"
      - "-c"
      - "shared_buffers=128MB"
      - "-c"
      - "effective_cache_size=384MB"
      - "-c"
      - "maintenance_work_mem=64MB"
      - "-c"
      - "work_mem=8MB"
    volumes:
      - /DATA/AppData/mediafusion/postgres:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U mediafusion -d mediafusion"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - pcs
    cpu_shares: 30
    deploy:
      resources:
        limits:
          memory: 256M

  # MongoDB
  mongodb:
    image: mongo:7
    container_name: mediafusion-mongodb
    restart: unless-stopped
    volumes:
      - /DATA/AppData/mediafusion/mongodb:/data/db
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
      interval: 10s
      timeout: 10s
      retries: 5
      start_period: 40s
    networks:
      - pcs
    cpu_shares: 30
    deploy:
      resources:
        limits:
          memory: 256M

  # Redis
  redis:
    image: redis:7-alpine
    container_name: mediafusion-redis
    restart: unless-stopped
    command: redis-server --appendonly yes --save 60 1
    volumes:
      - /DATA/AppData/mediafusion/redis:/data
    healthcheck:
      test: ["CMD-SHELL", "redis-cli --raw INFO | grep -q '^loading:0'"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - pcs
    cpu_shares: 20
    deploy:
      resources:
        limits:
          memory: 128M

  # Prowlarr - Indexer aggregator
  prowlarr:
    image: ghcr.io/hotio/prowlarr:latest
    container_name: mediafusion-prowlarr
    hostname: mediafusion-prowlarr-internal
    restart: unless-stopped
    environment:
      PUID: "1000"
      PGID: "1000"
      UMASK: "002"
      TZ: "UTC"
    expose:
      - 9696
    volumes:
      - /DATA/AppData/mediafusion/prowlarr:/config
    networks:
      - pcs
    cpu_shares: 20
    deploy:
      resources:
        limits:
          memory: 256M

  # FlareSolverr - Cloudflare bypass
  flaresolverr:
    image: ghcr.io/flaresolverr/flaresolverr:latest
    container_name: mediafusion-flaresolverr
    restart: unless-stopped
    expose:
      - 8191
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8191/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - pcs
    cpu_shares: 20
    deploy:
      resources:
        limits:
          memory: 512M

  # Browserless - Headless Chrome
  browserless:
    image: ghcr.io/browserless/chromium
    container_name: mediafusion-browserless
    restart: unless-stopped
    environment:
      TIMEOUT: "-1"
    expose:
      - 3000
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/json/version"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - pcs
    cpu_shares: 30
    deploy:
      resources:
        limits:
          memory: 512M

networks:
  pcs:
    external: true

x-casaos:
  architectures:
    - amd64
    - arm64
  main: landing
  author: Yundera
  developer: mhdzumair
  icon: https://cdn.jsdelivr.net/gh/krizcold/AppStore@main/Apps/StremioMediastream/icon.png
  tagline:
    en_us: Stremio addon with real torrent downloads via qBittorrent
  category: Media
  description:
    en_us: |
      PROTOTYPE - MediaFusion with pre-configured sources for testing.

      ⚠️ FOR INTERNAL TESTING ONLY - NOT FOR PRODUCTION ⚠️

      This version has automatic scrapers enabled (BT4G, YTS).
      Use this to test the qBittorrent peer connectivity improvement.

      ZERO CONFIG - Just install, copy URL, add to Stremio.

      Features:
      - qBittorrent backend with WebDAV streaming
      - IPv6 port 6881 exposed for peer connections
      - 10x more peers than Stremio's built-in engine
      - Pre-configured sources (BT4G, YTS)
  title:
    en_us: MediaFusion (Prototype)
  store_app_id: stremiomediastream-proto
  is_uncontrolled: false
  index: /
  webui_port: 80
  pre-install-cmd: |
    curl -fsSL https://raw.githubusercontent.com/krizcold/AppStore/main/Apps/StremioMediastream/scripts/pre-install.sh | bash
  tips:
    before_install:
      en_us: |
        ⚠️ PROTOTYPE - FOR TESTING ONLY ⚠️

        This version has automatic torrent sources enabled.
        Do NOT use in production - for internal testing only.

        After installation:
        1. Open the app - addon URL is ready
        2. Click "Install in Stremio"
        3. Test peer connectivity improvement

        Port 6881 exposed on IPv6 for 10x better peer connectivity.
