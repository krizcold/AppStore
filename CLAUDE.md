# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Session Startup

**IMPORTANT**: At the start of every session, read the `CONTRIBUTING.md` file to understand the current contribution guidelines, security requirements, and app submission process.

## Repository Overview

This is the **Yundera CasaOS 3rd-Party AppStore** - a curated collection of Docker Compose applications configured for CasaOS with NSL.SH mesh router integration. The repository contains containerized applications that run on CasaIMG (dockerized CasaOS) with HTTPS-enabled URLs.

## Architecture

### Core Structure
- `Apps/[AppName]/` - Individual application directories containing:
  - `docker-compose.yml` - CasaOS-compatible Docker Compose configuration
  - `icon.png` - Application icon (192x192px)
  - `screenshot-*.png` - Application screenshots (1280x720px)
  - `thumbnail.png` - Featured app thumbnail (784x442px)
  - `rationale.md` - Optional explanations for security exceptions

### Configuration Files
- `category-list.json` - App category definitions with icons and descriptions
- `recommend-list.json` - List of recommended apps by app ID
- `featured-apps.json` - Featured applications with editor and date metadata

### Key Technologies
- **Docker Compose** - All apps are containerized using Docker Compose format
- **CasaOS Extensions** - Apps use `x-casaos` metadata for store integration
- **NSL Router** - Mesh router system providing HTTPS URLs (e.g., `https://appname-username.nsl.sh`)
- **Yundera Infrastructure** - Cloud server platform optimized for container apps

## Docker Compose Requirements

### Mandatory Fields
```yaml
name: appname                    # Unique store app ID (lowercase, alphanumeric, _, -)
services:
  main-service:
    image: app:specific-tag      # Never use :latest
    user: $PUID:$PGID           # File permissions
    deploy:
      resources:
        limits:
          memory: 512M          # Resource limits required
          cpus: '0.5'
    expose:                     # For web UI (not ports)
      - 80
    environment:
      PUID: $PUID              # System variables
      PGID: $PGID
      TZ: $TZ
      PASSWORD: $default_pwd    # Secure default password
      DOMAIN: $domain          # NSL router domain
    volumes:
      - /DATA/AppData/$AppID/config:/app/config
    restart: unless-stopped

x-casaos:
  main: main-service            # Service providing web UI
  webui_port: 80               # Must match exposed port
  category: Media              # From category-list.json
  architectures: [amd64, arm64]
  description:
    en_us: App description
  title:
    en_us: App Name
  tagline:
    en_us: Short description
```

### Volume Mapping Patterns
- **App Data**: `/DATA/AppData/[AppName]/` - Primary app storage
- **Shared Media**: `/DATA/Media/`, `/DATA/Gallery/` - Cross-app content
- **User Files**: `/DATA/Documents/`, `/DATA/Downloads/`

### NSL Router Integration
- Use `expose` instead of `ports` for web UI
- Port 80 creates clean URLs: `https://appname-username.nsl.sh/`
- Other ports include port in URL: `https://3000-appname-username.nsl.sh/`

### Security Requirements
- No hardcoded credentials - use `$default_pwd`
- Specific version tags (never `:latest`)
- PUID/PGID for file permissions
- Resource limits on all services
- Default authentication enabled

## Development Workflow

### Testing New Apps
1. Create Docker Compose locally and test with `docker compose up -d`
2. Add CasaOS metadata (`x-casaos` section)
3. Test in CasaOS instance via SSH
4. Create app directory in `Apps/[AppName]/`
5. Test via forked GitHub repository as AppStore URL
6. Submit PR with proper asset links to main repository

### Asset Requirements
- **Icons**: PNG, 192x192px, transparent background
- **Screenshots**: PNG/JPG, 1280x720px, demonstrate functionality
- **Thumbnails**: PNG, 784x442px, rounded corners (for featured apps)
- **Asset URLs**: Must point to main repository via jsdelivr CDN

### Pre-install Commands
Use `pre-install-cmd` in `x-casaos` for setup automation:
```yaml
x-casaos:
  pre-install-cmd: docker run --rm -v /DATA/AppData/$AppID/:/data/ toolbox-image setup-script.sh
```

## Common Variables

### System Variables
- `$PUID/$PGID` - User/Group IDs (usually 1000:1000)
- `$TZ` - System timezone
- `$AppID` - Application name from compose `name` field
- `$default_pwd` - Secure password generated by CasaOS
- `$domain` - NSL router domain for the app
- `$public_ip` - Public IP for port announcements

### Environment Integration
- Environment variables stored in `/etc/casaos/env`
- Variables like `OPENAI_API_KEY` can be shared across apps
- Variable changes trigger container restarts

## File Validation

When working with this repository:
- Verify Docker Compose syntax and CasaOS compatibility
- Check asset file sizes and dimensions
- Validate security requirements (no root unless justified)
- Test URL accessibility via NSL router
- Ensure proper localization (English required, multi-language preferred)

## Testing Commands

No specific build/test commands - validation is done through:
- Docker Compose syntax validation
- CasaOS instance testing
- Asset file verification
- Security checklist review